---
- name: Deploy Node.js App with Nginx
  hosts: app1
  become: yes
  vars:
    app_directory: /var/www/myapp
    repo_url: https://github.com/your/repo.git

  tasks:
    - name: Install Git
      yum:
        name: git
        state: present

    - name: Install Nginx repository
      yum:
        name: "https://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.20.1-1.el7.ngx.x86_64.rpm"
        state: present

    - name: Install Nginx
      yum:
        name: nginx
        state: present

    - name: Start Nginx
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Create app directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: centos
        group: centos
        mode: '0755'

    - name: Clone the application code
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_directory }}"
        version: main
        force: yes

    - name: Install Node.js if not installed
      yum:
        name: nodejs
        state: present

    - name: Install app dependencies
      npm:
        path: "{{ app_directory }}"
        state: present
        production: yes
        executable: /usr/bin/npm

    - name: Ensure the app is running
      shell: |
        cd {{ app_directory }}
        npm start
      args:
        chdir: "{{ app_directory }}"
      async: 30
      poll: 0

    - name: Configure Nginx
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      notify:
        - Restart Nginx

    - name: Reload Nginx to apply changes
      service:
        name: nginx
        state: reloaded

  handlers:
  - name: Restart Nginx
    service:
    name: nginx
    state: restarted
    become: yes
...